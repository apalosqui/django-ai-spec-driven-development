{% extends 'base.html' %}
{% block title %}Dashboard — Finanpy{% endblock %}
{% block content %}
  <form method="get" class="mb-4 flex items-center gap-2" aria-label="Selecionar mês e ano">
    <label class="text-sm text-slate-300" for="sel-month">Mês</label>
    <select id="sel-month" name="month" class="bg-slate-800 border border-slate-700 rounded-md px-3 py-2 text-slate-100" aria-label="Selecionar mês">
      {% for m in months %}
        <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
      {% endfor %}
    </select>
    <label class="text-sm text-slate-300" for="sel-year">Ano</label>
    <select id="sel-year" name="year" class="bg-slate-800 border border-slate-700 rounded-md px-3 py-2 text-slate-100" aria-label="Selecionar ano">
      {% for y in years %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
    <button class="inline-flex items-center px-4 py-2 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700" type="submit" aria-label="Aplicar filtro">Aplicar</button>
  </form>

  <section class="mb-6">
    <div class="bg-slate-900/60 backdrop-blur border border-slate-800 rounded-xl p-5">
      <h2 class="font-semibold mb-4">Resumo financeiro do mês</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
          <div class="text-slate-400 text-sm">Receitas</div><div class="text-2xl font-semibold text-emerald-400">R$ {{ income_total }}</div>
        </div>
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
          <div class="text-slate-400 text-sm">Despesas</div><div class="text-2xl font-semibold text-rose-400">R$ {{ expense_total }}</div>
        </div>
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
          <div class="text-slate-400 text-sm">Performance</div>
          <div class="text-2xl font-semibold">R$ {{ performance_total }}</div>
        </div>
      </div>
    </div>
  </section>

  <section class="py-8">
    <div class="bg-slate-900/60 backdrop-blur border border-slate-800 rounded-xl p-5 mb-6">
      <h2 class="font-semibold mb-4">Timeline do mês</h2>
      <div id="timeline" class="space-y-2" role="list" aria-label="Eventos por dia do mês selecionado"></div>
      <p id="riskMsg" class="text-sm mt-2"></p>
    </div>
    <div class="bg-slate-900/60 backdrop-blur border border-slate-800 rounded-xl p-5">
      <h2 class="font-semibold mb-4">Demonstração de Projeção (MVP)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left">Data</th>
              <th class="px-3 py-2 text-right">Entrada</th>
              <th class="px-3 py-2 text-right">Saída</th>
              <th class="px-3 py-2 text-right">Diário</th>
              <th class="px-3 py-2 text-right">Saldo</th>
            </tr>
          </thead>
          <tbody id="projBody"></tbody>
        </table>
      </div>
      <p id="projMsg" class="text-slate-400 text-sm mt-3"></p>
    </div>
  </section>
  <script>
    (function() {
      const body = document.getElementById('projBody');
      const msg = document.getElementById('projMsg');
      const timeline = document.getElementById('timeline');
      const riskMsg = document.getElementById('riskMsg');
      async function loadProjection() {
        body.innerHTML = '';
        msg.textContent = '';
        timeline.innerHTML = '';
        riskMsg.textContent = '';
        const start = '{{ base_start|date:"Y-m-d" }}';
        try {
          const res = await fetch(`/api/projection/?start=${start}&months={{ span_months }}`);
          if (!res.ok) { msg.textContent = 'Não foi possível obter a projeção.'; return; }
          const data = await res.json();
          const first = new Date('{{ first_day|date:"Y-m-d" }}');
          const last = new Date('{{ last_day|date:"Y-m-d" }}');
          const inMonth = data.filter(d => { const dt = new Date(d.date); return dt >= first && dt <= last; });
          const rows = inMonth.map(d => `
            <tr class=\"border-t border-slate-800\">\
              <td class=\"px-3 py-2\">${d.date.split('-').reverse().join('-')}</td>\
              <td class=\"px-3 py-2 text-right\">R$ ${Number(d.entrada).toFixed(2)}</td>\
              <td class=\"px-3 py-2 text-right\">R$ ${Number(d.saida).toFixed(2)}</td>\
              <td class=\"px-3 py-2 text-right\">R$ ${Number(d.diario).toFixed(2)}</td>\
              <td class=\"px-3 py-2 text-right font-medium ${Number(d.saldo) < 0 ? 'text-rose-400' : 'text-slate-100'}\">R$ ${Number(d.saldo).toFixed(2)}</td>\
            </tr>`).join('');
          body.innerHTML = rows || '<tr><td class=\"px-3 py-3 text-slate-400\" colspan=\"5\">Sem dados para o período.</td></tr>';

          // Timeline com ícones por tipo de evento
          const ICON = { SALARIO: '💼', FIXO: '🧾', VARIAVEL: '📊', FATURA: '💳', TRANSFER: '🔁' };
          let anyRiskFuture = false;
          const today = new Date();
          inMonth.forEach(d => {
            const dt = new Date(d.date);
            const br = d.date.split('-').reverse().join('-');
            const risk = Number(d.saldo) < 0;
            if (risk && dt >= today) anyRiskFuture = true;
            const icons = (d.eventos || []).map(e => ICON[e.type] || '•').join(' ');
            const line = document.createElement('div');
            line.setAttribute('role','listitem');
            line.className = `flex items-center justify-between rounded-lg border px-3 py-2 ${risk ? 'border-rose-900/60 bg-rose-950/20' : 'border-slate-800 bg-slate-900/40'}`;
            line.innerHTML = `
              <div class="flex items-center gap-2">
                <span class="inline-block w-2 h-2 rounded-full ${risk ? 'bg-rose-500' : 'bg-emerald-500'}" aria-hidden="true"></span>
                <span class="text-slate-200">${br}</span>
                <span class="text-slate-400">${icons}</span>
              </div>
              <div class="text-right ${risk ? 'text-rose-400' : 'text-slate-300'}">R$ ${Number(d.saldo).toFixed(2)}</div>
            `;
            timeline.appendChild(line);
          });
          if (anyRiskFuture) {
            riskMsg.textContent = 'Atenção: há dias futuros com saldo negativo neste período.';
            riskMsg.className = 'text-rose-400';
          } else {
            riskMsg.textContent = 'Sem riscos de saldo negativo futuro neste período.';
            riskMsg.className = 'text-emerald-400';
          }
        } catch (e) { msg.textContent = 'Erro inesperado ao consultar a projeção.'; }
      }
      loadProjection();
    })();
  </script>
{% endblock %}

